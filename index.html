<html>
	<head>
		<style>
            /* Load the flappybird font locally */
            @font-face {
                font-family: 'flappybird';
                src: url('fonts/04B_19.TTF') format('truetype');
            }
            
			body{
				margin: 0;
				width:100%;
				height:100%;
                overflow: hidden;
			}
			#Canvas{
                position:relative;
				width: 100%;
				height: 100%;
				background: steelblue;
			}
			#Birdy{
		        width: 2.9%;
                padding-bottom: 2%;
                background-image: url('bird.png');
                background-size: 300%;
                background-repeat: no-repeat;
				position:absolute;
				top: 50%;
				left: 20%;
                z-index: 150;
			}
            
            .FallenBirdy{
                transform: rotate(90deg);
            }
            
            #PauseButton{
                position:absolute;
                top: 2%; 
                right: 1%;
                width: 3%;
                height: 0;
                padding-top: 1.25%;
                padding-bottom: 1.75%;
                background: orange;
                border-radius: 5px;
                font-size: 2.6vw;
                text-align: center;
                z-index: 50;
                cursor:pointer;
            }
            #PauseButton span{
                line-height: 3%;
                margin-left: 3%;
            }
            
            .Pipe{
                position:absolute;
                top: 0;
                left: 100%;
                width: 5%;
                background: greenyellow;
                animation: PipeMovement 3s linear;
            }
            
            @keyframes PipeMovement{
                from {left: 100%}
                to {left: -25%}
            }
            
            .paused {
                animation-play-state: paused;
             }
             
             .noSelect{
                 user-select: none;
             }
             
             #LostScoreScreen{
                position: relative;
                left: -50%;
                margin-top: -70%;
                padding: 5px 0px 5px 12px;
                background: #ded895;
                border-radius: 4%;
                border: 2px solid black;
                text-align: center;
                display: none;
                font-family: flappybird;
                font-size: 2vw;
                color:white;                
                text-shadow:
                    -2px -2px 0 #000,  
                    2px -2px 0 #000,
                    -2px 2px 0 #000,
                    2px 2px 0 #000;
                z-index: 150;
             }
             
             #CurrentScoreCard{
                position: relative;
                left: -50%;
                margin-top: -700%;
                text-align: center;
                font-family: flappybird;
                font-size: 4vw;
                color:white;                
                text-shadow:
                    -2px -2px 0 #000,  
                    2px -2px 0 #000,
                    -2px 2px 0 #000,
                    2px 2px 0 #000;
                z-index: 50;
             }
            
            #DebugInfo{
                display: none;
            }

            #GlowingText {
                position: absolute;
                bottom: 10%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-family: flappybird;
                font-size: 3vw;
                color: white;
                text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #fff, 0 0 40px #ff00de, 0 0 70px #ff00de, 0 0 80px #ff00de, 0 0 100px #ff00de, 0 0 150px #ff00de;
                z-index: 200;
                display: none;
            }
		</style>
        <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
	</head>
	<body>
		<div id="Canvas">
            <div id="InstructionBox" style="position: absolute; left: 50%; display:none;">
                <div style="position: relative; left: -50%; z-index: 150; font-family:flappybird; color:white; font-size: 2vw;" class="noSelect">
                    Click to Fly <br>
                    Space Bar to Reset <br>
                    "P" to Pause
                </div>
            </div>
                        
            <div style="position: absolute; left: 50%; top: 50%;">
                <div id="CurrentScoreCard" class="noSelect">
                    <span id="CurrentScore">0</span>
                </div>
            </div>
            
            <div style="position: absolute; left: 50%; top: 50%;">
                <div id="LostScoreScreen" class="noSelect">
                    <span>Score</span>
                    <br>
                    <span id="FinalScore">0</span>
                    <br>
                    <span>Best</span>
                    <br>
                    <span id="BestScore">0</span>
                    <br>
                    <button id="ResetButton" type="button" class="btn btn-warning">Reset</button>
                </div>
            </div>
            
            <div id="DebugInfo" class="noSelect"></div>
			<div id="Birdy" style="background-position-x: 400%;"></div>
            <div id="PauseButton" class="noSelect">
                <span class="glyphicon glyphicon-pause"></span>
            </div>

            <div id="GlowingText" class="noSelect">
                The game starts off basic, but progressively gets more awesome!
            </div>
		</div>
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
		<script>
			$(function(){
                // Initialization code
                $('#InstructionBox').slideDown();
                setTimeout(() => $('#InstructionBox').slideUp(), 5000);
                
                const canvasObject = $('#Canvas');
                let gameLoopIntervalID = 0;
                let Paused = true;
                let Lost = false;
                let clickCount = 0;
                let CurrentScore = 0;

                // Game functions
                function pauseGame(){
                    clearInterval(gameLoopIntervalID);
                    $('.Pipe').addClass('paused');
                    $('#PauseButton span').toggleClass('glyphicon-pause glyphicon-play');
                    Paused = true;
                }
                
                function startGame(){
                    if(Lost) return;
                    gameLoopIntervalID = setInterval(gameLoop, 30);
                    $('.Pipe').removeClass('paused');
                    $('#PauseButton span').toggleClass('glyphicon-play glyphicon-pause');
                    Paused = false;
                }
                
                function endGame(){
                    Lost = true;
                    pauseGame();
                    const cookieScore = parseInt(getCookie('HighScore')) || 0;
                    setCookie('HighScore', Math.max(CurrentScore, cookieScore), 30);
                    Birdy.BirdyObject.animate({top:'90%'}, 1500, 'linear');
                    $('#FinalScore').text(CurrentScore);
                    $('#BestScore').text(Math.max(CurrentScore, cookieScore));
                    $('#LostScoreScreen').slideDown();
                }
                
                function resetGame(){
                    pauseGame();
                    $('.Pipe').remove();
                    Lost = false;
                    CurrentScore = 0;
                    Birdy.Reset();
                    startGame();
                    $('#LostScoreScreen').slideUp();
                    $('#CurrentScore').text('0');
                }

                // Event handlers
                $('#PauseButton').on('mousedown', (e) => {
                    e.stopPropagation();
                    Paused ? startGame() : pauseGame();
                });
                
                $('#ResetButton').click(resetGame);
                
				canvasObject.mousedown(() => !Paused && Birdy.jump());
                
                $(document).keydown(e => {
                    if(e.which === 32) resetGame();
                    if(e.which === 80) Paused ? startGame() : pauseGame();
                });

                // Game loop
                let gameLoopCounter = 0;
                function gameLoop(){
                    if(gameLoopCounter % 2 === 0){
                        incrementScore();
                        checkCollisions();
                    }
                    
                    isInBound(Birdy.BirdyObject, canvasObject);
                    Birdy.fall();
                    
                    if(gameLoopCounter % 90 === 0){
                        addPipe();
                        cleanPipes();
                    }
                    
                    if(gameLoopCounter % 7 === 0){
                        Birdy.flapWings();
                    }
                    
                    gameLoopCounter++;
                }

                // Bird object
				const Birdy = new (function(){
					const selectorObject = $('#Birdy');
					let jumping = false;
					let gravVeloc = 0;
					const gravAccel = 0.3;
                    const terminalVelocity = 5;
                    let Angle = 0;
                    let WingPosition = 0;
                    const WingPositions = [0, 1, 2, 1];
					
                    this.Reset = function(){
                        jumping = false;
                        gravVeloc = 0;
                        Angle = 0;
                        WingPosition = 0;
                        selectorObject.stop().rotate(0).css('top','50%');
                    }
                    
					this.fall = function(){
						if(!jumping){
							selectorObject.stop().animate({top:'+='+gravVeloc+'%'}, 30, 'linear');
							gravVeloc = Math.min(gravVeloc + gravAccel, terminalVelocity);
                            const AdjustedAngle = Angle + 15 * (gravVeloc/terminalVelocity)**2;
                            adjustAngle(Math.min(AdjustedAngle,90));
                        }
					};
					
					this.jump = function(){
                        if(Paused) return;
						jumping = true;
                        adjustAngle(-45);
						selectorObject.stop().animate({top:'-=9%'}, 100, 'linear', () => {
							jumping = false;
							this.fall();
						});
					};
                    
                    this.flapWings = function(){
                        WingPosition = Angle > 45 ? 1 : (WingPosition + 1) % 4;
                        selectorObject.css("background-position-x", WingPositions[WingPosition]*50 + "%");
                    }
                    
                    const adjustAngle = angle => {
                        selectorObject.rotate(angle);
                        Angle = angle;
                    }
                    
                    this.BirdyObject = selectorObject;
				});

                // Helper functions
                function addPipe(){
                    const PipeGap = 30;
                    const MinPipeHeight = 5;
                    const MaxTopPipeHeight = 100 - PipeGap - 2*MinPipeHeight;
                    const TopPipeHeight = Math.random()*MaxTopPipeHeight + MinPipeHeight;
                    const BottomPipeTop = TopPipeHeight + PipeGap;
                    
                    $('<div/>').addClass('Pipe').css('height',TopPipeHeight+'%').data('scored', false).appendTo(canvasObject); 
                    $('<div/>').addClass('Pipe BottomPipe').css({
                        height: (100 - BottomPipeTop)+'%',
                        top: BottomPipeTop+'%'
                    }).data('scored', false).appendTo(canvasObject); 
                }
                
                function cleanPipes(){
                    $('.Pipe').each(function(){
                        if($(this).offset().left/$(this).parent().width() < -0.2){ 
                            $(this).remove();
                        }
                    });
                }
                
                function checkCollisions(){
                    $('.Pipe').each(function(){
                        if(isIntersecting(Birdy.BirdyObject, $(this))) endGame();
                    });
                }
                
                function isIntersecting(obj1, obj2){
                    const obj1Dim = [obj1.offset().left, obj1.offset().top, obj1.offset().left+obj1.width(), obj1.offset().top+obj1.height()];
                    const obj2Dim = [obj2.offset().left, obj2.offset().top, obj2.offset().left+obj2.width(), obj2.offset().top+obj2.height()];
                    return !(obj1Dim[3] < obj2Dim[1] || obj1Dim[1] > obj2Dim[3] || obj1Dim[0] > obj2Dim[2] || obj1Dim[2] < obj2Dim[0]);
                }
                
                function isInBound(birdy, canvas){
                    if(birdy.offset().top + birdy.height() > canvas.offset().top + canvas.height() || 
                       birdy.offset().top < canvas.offset().top) endGame();
                }
                
                function incrementScore(){
                    $('.BottomPipe').each(function(){
                        const BirdyBeakXPos = Birdy.BirdyObject.offset().left + Birdy.BirdyObject.width();
                        const PipeRightXPos = $(this).offset().left + $(this).width();
                        if(!$(this).data('scored') && BirdyBeakXPos > PipeRightXPos){
                            CurrentScore++;
                            $(this).data('scored', true);
                            $('#CurrentScore').text(CurrentScore);
                        }
                    }); 
                }

                // Start the game
                startGame();
                
                // Rotation plugin
                jQuery.fn.rotate = function(deg) {
                    return this.css({'transform': `rotate(${deg}deg)`});
                };

                // Cookie functions
                function setCookie(name, value, days) {
                    const d = new Date();
                    d.setTime(d.getTime() + (days*24*60*60*1000));
                    document.cookie = `${name}=${value};expires=${d.toUTCString()};path=/`;
                }
                
                function getCookie(name) {
                    const cookies = document.cookie.split(';');
                    for(let c of cookies) {
                        c = c.trim();
                        if(c.startsWith(name + '=')) return c.substring(name.length+1);
                    }
                    return "";
                }
			});
		</script>
	</body>
</html>
